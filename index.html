<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÇ°Á•®‰ª∑ÂÄºËÆ°ÁÆóÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 10px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            max-width: 100%;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 8px 6px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 16px;
            margin-bottom: 2px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 10px;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 6px;
        }
        
        .input-group {
            margin-bottom: 3px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 1px;
            font-weight: 600;
            color: #333;
            font-size: 9px;
        }
        
        .input-group input {
            width: 100%;
            padding: 4px;
            border: 1px solid #e1e5e9;
            border-radius: 3px;
            font-size: 11px;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #4CAF50;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .input-group input::placeholder {
            color: #999;
            font-size: 11px;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 5px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 6px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }
        
        .calculate-btn:active {
            transform: translateY(0);
        }
        
        .results {
            margin-top: 6px;
            padding: 5px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 4px;
            border-left: 2px solid #4CAF50;
            display: none;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 3px;
            padding: 2px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .result-label {
            font-weight: 600;
            color: #495057;
            font-size: 10px;
        }
        
        .result-value {
            color: #28a745;
            font-weight: 700;
            font-size: 12px;
        }
        
        
        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
        }
        
        .info-tip {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
            font-size: 14px;
        }
        
        .info-tip strong {
            color: #0c5460;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .rate-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #c3e6cb;
            font-size: 14px;
        }
        
        .auto-loading {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
            font-size: 14px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 2px;
            }
            
            .container {
                margin: 0;
                border-radius: 6px;
            }
            
            .header {
                padding: 4px;
            }
            
            .header h1 {
                font-size: 14px;
            }
            
            .header p {
                font-size: 8px;
            }
            
            .form-container {
                padding: 4px;
            }
            
            /* ÁßªÂä®Á´ØÊîπ‰∏∫ÂçïÂàóÂ∏ÉÂ±Ä */
            .grid-2-columns {
                grid-template-columns: 1fr !important;
                gap: 3px !important;
                margin-bottom: 4px !important;
            }
            
            .result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1px;
            }
            
            .input-group {
                margin-bottom: 2px;
            }
            
            .input-group label {
                font-size: 8px;
            }
            
            .input-group input {
                padding: 3px;
                font-size: 10px;
            }
            
            .input-group input::placeholder {
                font-size: 10px;
            }
            
            .calculate-btn {
                padding: 4px;
                font-size: 10px;
                margin-top: 4px;
            }
            
            .results {
                margin-top: 4px;
                padding: 3px;
            }
            
            .result-label {
                font-size: 9px;
            }
            
            .result-value {
                font-size: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 12px;
            }
            
            .header p {
                font-size: 7px;
            }
            
            .form-container {
                padding: 3px;
            }
            
            .input-group {
                margin-bottom: 1px;
            }
            
            .grid-2-columns {
                gap: 2px !important;
                margin-bottom: 3px !important;
            }
            
            .input-group label {
                font-size: 7px;
            }
            
            .input-group input {
                padding: 2px;
                font-size: 9px;
            }
            
            .input-group input::placeholder {
                font-size: 9px;
            }
            
            .header {
                padding: 3px;
            }
            
            .results {
                padding: 2px;
            }
        }
        
        @media (max-width: 360px) {
            .header h1 {
                font-size: 11px;
            }
            
            .header p {
                font-size: 6px;
            }
            
            .form-container {
                padding: 2px;
            }
            
            .input-group {
                margin-bottom: 1px;
            }
            
            .input-group label {
                font-size: 6px;
            }
            
            .input-group input {
                padding: 2px;
                font-size: 8px;
            }
            
            .input-group input::placeholder {
                font-size: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà ËÇ°Á•®‰ª∑ÂÄºËÆ°ÁÆóÂô®</h1>
            <p>üîí Êï∞ÊçÆÂÄºËÆ∞ÂΩïÂú®ÊÇ®ÁöÑËÆæÂ§á‰∏≠ÔºåÂèØÂÆâÂÖ®‰ΩøÁî®</p>
        </div>
        
        <div class="form-container">
            
            <!-- Ë°åÊùÉ‰ª∑ÂíåÊåÅÊúâËÇ°Êï∞ÁªÑÂêà -->
            <div class="grid-2-columns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 4px;">
                <div class="input-group">
                    <label for="shares">üìä ÊåÅÊúâËÇ°Êï∞</label>
                    <input type="number" id="shares" placeholder="ËØ∑ËæìÂÖ•ÊåÅÊúâËÇ°Êï∞" min="0" step="1">
                </div>
                
                <div class="input-group">
                    <label for="strikePrice">‚ö° Ë°åÊùÉ‰ª∑ (USD)</label>
                    <input type="number" id="strikePrice" placeholder="ËØ∑ËæìÂÖ•Ë°åÊùÉ‰ª∑" min="0" step="0.01">
                </div>
            </div>
            
            <!-- ÁæéËÇ°ÂíåÊ∏ØËÇ°‰∏§ÂàóÂ∏ÉÂ±Ä -->
            <div class="grid-2-columns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 4px;">
                <!-- ÁæéËÇ°Âàó -->
                <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); padding: 4px; border-radius: 4px; border-left: 2px solid #2196f3;">
                    <h3 style="margin: 0 0 3px 0; color: #1976d2; font-size: 10px; text-align: center;">üá∫üá∏ ÁæéËÇ° HSAI</h3>
                    
                    <div class="input-group">
                        <label for="usStockCode">ËÇ°Á•®‰ª£Á†Å</label>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <input type="text" id="usStockCode" placeholder="ÁæéËÇ°‰ª£Á†Å" value="HSAI" style="flex: 1;">
                            <button type="button" id="fetchUsPriceBtn" onclick="fetchUSStockPrice()" style="padding: 3px 6px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px;">
                                üìà
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="usPrice">ËÇ°‰ª∑ (USD)</label>
                        <input type="number" id="usPrice" min="0" step="0.01">
                    </div>
                    
                    <div class="input-group">
                        <label for="usdToCny">ÁæéÂÖÉÊ±áÁéá</label>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <input type="number" id="usdToCny" placeholder="USD/CNY" min="0" step="0.0001" style="flex: 1;">
                            <button type="button" id="fetchUsdBtn" onclick="fetchUSDExchangeRate()" style="padding: 3px 6px; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px;">
                                üîÑ
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Ê∏ØËÇ°Âàó -->
                <div style="background: linear-gradient(135deg, #fff3e0, #fce4ec); padding: 4px; border-radius: 4px; border-left: 2px solid #ff9800;">
                    <h3 style="margin: 0 0 3px 0; color: #f57c00; font-size: 10px; text-align: center;">üá≠üá∞ Ê∏ØËÇ° 02525</h3>
                    
                    <div class="input-group">
                        <label for="hkStockCode">ËÇ°Á•®‰ª£Á†Å</label>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <input type="text" id="hkStockCode" placeholder="Ê∏ØËÇ°‰ª£Á†Å" value="02525" style="flex: 1;">
                            <button type="button" id="fetchHkPriceBtn" onclick="fetchHKStockPrice()" style="padding: 3px 6px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px;">
                                üìà
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="hkPrice">ËÇ°‰ª∑ (HKD)</label>
                        <input type="number" id="hkPrice" min="0" step="0.01">
                    </div>
                    
                    <div class="input-group">
                        <label for="hkdToCny">Ê∏ØÂÖÉÊ±áÁéá</label>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <input type="number" id="hkdToCny" placeholder="HKD/CNY" min="0" step="0.0001" style="flex: 1;">
                            <button type="button" id="fetchHkdBtn" onclick="fetchHKDExchangeRate()" style="padding: 3px 6px; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px;">
                                üîÑ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 4px 0;">
                <button type="button" onclick="fetchAllStockData()" style="padding: 4px 8px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px; font-weight: 600; margin-right: 4px; box-shadow: 0 1px 2px rgba(40, 167, 69, 0.3); transition: all 0.3s ease;">
                    üìä Ëé∑ÂèñÊâÄÊúâÊï∞ÊçÆ
                </button>
                <button type="button" onclick="fetchAllExchangeRates()" style="padding: 4px 8px; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px; font-weight: 600; margin-right: 4px; box-shadow: 0 1px 2px rgba(23, 162, 184, 0.3); transition: all 0.3s ease;">
                    üåê ‰ªÖÊ±áÁéá
                </button>
                <button type="button" onclick="clearLocalStorage()" style="padding: 4px 8px; background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px; font-weight: 600; box-shadow: 0 1px 2px rgba(220, 53, 69, 0.3); transition: all 0.3s ease;">
                    üóëÔ∏è Ê∏ÖÁ©∫Êï∞ÊçÆ
                </button>
            </div>
            
            <!-- <button class="calculate-btn" onclick="calculateValue()">
                üßÆ ËÆ°ÁÆó‰ª∑ÂÄº
            </button>
             -->
            <div id="results" class="results">
                <h3 style="text-align: center; margin: 0 0 4px 0; color: #333; font-size: 11px;">üìä ‰ª∑ÂÄºËÆ°ÁÆóÁªìÊûú</h3>
                
                <!-- Â∏ÇÂÄºÁªìÊûú‰∏§ÂàóÂ∏ÉÂ±Ä -->
                <div class="grid-2-columns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                    <!-- ÁæéËÇ°Â∏Ç‰ª∑ÂÄºÂàó -->
                    <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); padding: 4px; border-radius: 3px; border-left: 2px solid #2196f3;">
                        <h4 style="margin: 0 0 3px 0; color: #1976d2; font-size: 9px; text-align: center;">üá∫üá∏ ÁæéËÇ°Â∏Ç‰ª∑ÂÄº</h4>
                        <div style="text-align: center;">
                            <span id="usMarketValue" class="result-value" style="display: block; font-size: 11px; color: #28a745; font-weight: bold;"></span>
                        </div>
                    </div>
                    
                    <!-- Ê∏ØËÇ°Â∏Ç‰ª∑ÂÄºÂàó -->
                    <div style="background: linear-gradient(135deg, #fff3e0, #fce4ec); padding: 4px; border-radius: 3px; border-left: 2px solid #ff9800;">
                        <h4 style="margin: 0 0 3px 0; color: #f57c00; font-size: 9px; text-align: center;">üá≠üá∞ Ê∏ØËÇ°Â∏Ç‰ª∑ÂÄº</h4>
                        <div style="text-align: center;">
                            <span id="hkMarketValue" class="result-value" style="display: block; font-size: 11px; color: #28a745; font-weight: bold;"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="error" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        function calculateValue() {
            // Ëé∑ÂèñËæìÂÖ•ÂÄº
            const shares = parseFloat(document.getElementById('shares').value) || 0;
            const usPrice = parseFloat(document.getElementById('usPrice').value) || 0;
            const hkPrice = parseFloat(document.getElementById('hkPrice').value) || 0;
            const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 0;
            const usdToCny = parseFloat(document.getElementById('usdToCny').value) || 0;
            const hkdToCny = parseFloat(document.getElementById('hkdToCny').value) || 0;
            
            // ÈöêËóèÈîôËØØ‰ø°ÊÅØ
            document.getElementById('error').style.display = 'none';
            
            // È™åËØÅËæìÂÖ•
            if (shares <= 0) {
                showError('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËÇ°Êï∞');
                return;
            }
            
            if (usPrice <= 0 && hkPrice <= 0) {
                showError('ËØ∑Ëá≥Â∞ëËæìÂÖ•‰∏ÄÁßçËÇ°‰ª∑ÔºàÁæéËÇ°ÊàñÊ∏ØËÇ°Ôºâ');
                return;
            }
            
            if (usPrice > 0 && usdToCny <= 0) {
                showError('ËØ∑ËæìÂÖ•ÁæéÂÖÉÂÖë‰∫∫Ê∞ëÂ∏ÅÊ±áÁéá');
                return;
            }
            
            if (hkPrice > 0 && hkdToCny <= 0) {
                showError('ËØ∑ËæìÂÖ•Ê∏ØÂÖÉÂÖë‰∫∫Ê∞ëÂ∏ÅÊ±áÁéá');
                return;
            }
            
            if (strikePrice <= 0) {
                showError('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑË°åÊùÉ‰ª∑');
                return;
            }
            
            // ËÆ°ÁÆó‰ª∑ÂÄº
            let usMarketValue = 0;
            let hkMarketValue = 0;
            let usCalculation = '';
            let hkCalculation = '';
            
            if (usPrice > 0 && usdToCny > 0) {
                // ÁæéËÇ°ËÆ°ÁÆóÔºö(ËÇ°‰ª∑ - Ë°åÊùÉ‰ª∑) * ËÇ°Êï∞ * Ê±áÁéá
                const usProfitPerShare = usPrice - strikePrice;
                usMarketValue = usProfitPerShare * shares * usdToCny;
                usCalculation = `(${usPrice.toFixed(2)} - ${strikePrice.toFixed(2)}) √ó ${shares.toLocaleString()} √ó ${usdToCny.toFixed(4)} = ${formatCurrency(usMarketValue)}`;
            }
            
            if (hkPrice > 0 && hkdToCny > 0) {
                // Ê∏ØËÇ°ËÆ°ÁÆóÔºöÂÖàÂ∞ÜË°åÊùÉ‰ª∑ËΩ¨Êç¢‰∏∫Ê∏ØÂÖÉÔºåÁÑ∂ÂêéËÆ°ÁÆó (ËÇ°‰ª∑ - Ë°åÊùÉ‰ª∑) * ËÇ°Êï∞ * Ê±áÁéá
                const strikePriceInHKD = strikePrice * usdToCny / hkdToCny; // ÁæéÂÖÉË°åÊùÉ‰ª∑ËΩ¨Êç¢‰∏∫Ê∏ØÂÖÉ
                const hkProfitPerShare = hkPrice - strikePriceInHKD;
                hkMarketValue = hkProfitPerShare * shares * hkdToCny;
                hkCalculation = `(${hkPrice.toFixed(2)} - ${strikePriceInHKD.toFixed(2)}) √ó ${shares.toLocaleString()} √ó ${hkdToCny.toFixed(4)} = ${formatCurrency(hkMarketValue)}`;
            }
            
            // ÊòæÁ§∫ÁªìÊûúÂíåËÆ°ÁÆóËøáÁ®ã
            if (usMarketValue !== 0) {
                document.getElementById('usMarketValue').innerHTML = 
                    `<div style="text-align: right;">
                        <div style="font-weight: 700; color: #28a745; font-size: 18px;">${formatCurrency(usMarketValue)}</div>
                        <div style="color: #666; font-size: 11px; margin-top: 4px; line-height: 1.3;">${usCalculation}</div>
                    </div>`;
            } else {
                document.getElementById('usMarketValue').textContent = 'Êú™ËÆ°ÁÆó';
            }
            
            if (hkMarketValue !== 0) {
                document.getElementById('hkMarketValue').innerHTML = 
                    `<div style="text-align: right;">
                        <div style="font-weight: 700; color: #28a745; font-size: 18px;">${formatCurrency(hkMarketValue)}</div>
                        <div style="color: #666; font-size: 11px; margin-top: 4px; line-height: 1.3;">${hkCalculation}</div>
                    </div>`;
            } else {
                document.getElementById('hkMarketValue').textContent = 'Êú™ËÆ°ÁÆó';
            }
            
            document.getElementById('results').style.display = 'block';
        }
        
        function formatCurrency(value) {
            return value.toLocaleString('zh-CN', {
                style: 'currency',
                currency: 'CNY',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('results').style.display = 'none';
        }
        
        // ÂÖÅËÆ∏ÊåâEnterÈîÆËÆ°ÁÆó
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateValue();
            }
        });
        
        // ÂÆûÊó∂ËÆ°ÁÆóÔºàÂΩìÊâÄÊúâÂøÖË¶ÅÂ≠óÊÆµÈÉΩÊúâÂÄºÊó∂Ôºâ
        function autoCalculate() {
            const shares = parseFloat(document.getElementById('shares').value) || 0;
            const usPrice = parseFloat(document.getElementById('usPrice').value) || 0;
            const hkPrice = parseFloat(document.getElementById('hkPrice').value) || 0;
            const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 0;
            const usdToCny = parseFloat(document.getElementById('usdToCny').value) || 0;
            const hkdToCny = parseFloat(document.getElementById('hkdToCny').value) || 0;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâË∂≥Â§üÁöÑËæìÂÖ•Êù•ËÆ°ÁÆó
            const hasUSData = usPrice > 0 && usdToCny > 0 && strikePrice > 0;
            const hasHKData = hkPrice > 0 && hkdToCny > 0 && strikePrice > 0;
            
            if (shares > 0 && (hasUSData || hasHKData)) {
                calculateValue();
            }
        }
        
        // ‰∏∫ÊâÄÊúâËæìÂÖ•Ê°ÜÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function() {
                autoCalculate();
                saveToLocalStorage(); // Ëá™Âä®‰øùÂ≠ò
            });
        });
        
        // ‰∏∫ÊñáÊú¨ËæìÂÖ•Ê°ÜÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.querySelectorAll('input[type="text"]').forEach(input => {
            input.addEventListener('input', function() {
                saveToLocalStorage(); // Ëá™Âä®‰øùÂ≠ò
            });
        });
        
        // ‰∏∫Ë°åÊùÉ‰ª∑ËæìÂÖ•Ê°ÜÊ∑ªÂä†ÁâπÊÆäÂ§ÑÁêÜ
        document.getElementById('strikePrice').addEventListener('input', function() {
            autoCalculate();
            saveToLocalStorage(); // Ëá™Âä®‰øùÂ≠ò
        });
        
        // ‰∏∫ËÇ°Á•®‰ª£Á†ÅËæìÂÖ•Ê°ÜÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.getElementById('usStockCode').addEventListener('blur', function() {
            if (this.value.trim()) {
                fetchUSStockPrice();
            }
        });
        
        document.getElementById('hkStockCode').addEventListener('blur', function() {
            if (this.value.trim()) {
                fetchHKStockPrice();
            }
        });
        
        // ËÇ°‰ª∑Ëé∑ÂèñÂäüËÉΩ - ÊîØÊåÅÂ§ö‰∏™API
        async function fetchUSStockPrice() {
            const btn = document.getElementById('fetchUsPriceBtn');
            const input = document.getElementById('usPrice');
            const stockCode = document.getElementById('usStockCode').value.trim().toUpperCase();
            const originalText = btn.textContent;
            
            if (!stockCode) {
                showError('ËØ∑ËæìÂÖ•ÁæéËÇ°‰ª£Á†Å');
                return;
            }
            
            btn.textContent = '‚è≥ Ëé∑Âèñ‰∏≠...';
            btn.disabled = true;
            btn.classList.add('loading');
            
            try {
                // Â∞ùËØïÂ§ö‰∏™APIÊ∫ê
                let price = null;
                let apiSource = '';
                
                // 1. Â∞ùËØïÊñ∞Êµ™Ë¥¢ÁªèAPI
                try {
                    const sinaResponse = await fetch(`http://hq.sinajs.cn/list=gb_${stockCode.toLowerCase()}`, {
                        mode: 'no-cors'
                    });
                    // Áî±‰∫éCORSÈôêÂà∂ÔºåÊñ∞Êµ™APIÂèØËÉΩÊó†Ê≥ïÁõ¥Êé•Ë∞ÉÁî®
                } catch (sinaError) {
                    console.log('Êñ∞Êµ™APIË∞ÉÁî®Â§±Ë¥•:', sinaError);
                }
                
                // 2. Â∞ùËØïËÖæËÆØË¥¢ÁªèAPI
                try {
                    const tencentResponse = await fetch(`http://qt.gtimg.cn/q=us${stockCode}`, {
                        mode: 'no-cors'
                    });
                    // Áî±‰∫éCORSÈôêÂà∂ÔºåËÖæËÆØAPIÂèØËÉΩÊó†Ê≥ïÁõ¥Êé•Ë∞ÉÁî®
                } catch (tencentError) {
                    console.log('ËÖæËÆØAPIË∞ÉÁî®Â§±Ë¥•:', tencentError);
                }
                
                // 3. Â∞ùËØïYahoo Finance API
                try {
                    const yahooResponse = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${stockCode}`);
                    const yahooData = await yahooResponse.json();
                    
                    if (yahooData.chart && yahooData.chart.result && yahooData.chart.result[0]) {
                        const quote = yahooData.chart.result[0].meta;
                        price = quote.regularMarketPrice;
                        apiSource = 'Yahoo Finance';
                    }
                } catch (yahooError) {
                    console.log('Yahoo Finance APIË∞ÉÁî®Â§±Ë¥•:', yahooError);
                }
                
                // 4. Â∞ùËØïFinnhub API (ÂÖçË¥π)
                if (!price) {
                    try {
                        const finnhubResponse = await fetch(`https://finnhub.io/api/v1/quote?symbol=${stockCode}&token=free`);
                        const finnhubData = await finnhubResponse.json();
                        
                        if (finnhubData.c && finnhubData.c > 0) {
                            price = finnhubData.c;
                            apiSource = 'Finnhub';
                        }
                    } catch (finnhubError) {
                        console.log('Finnhub APIË∞ÉÁî®Â§±Ë¥•:', finnhubError);
                    }
                }
                
                // 5. Â∞ùËØïPolygon.io API (ÂÖçË¥π)
                if (!price) {
                    try {
                        const polygonResponse = await fetch(`https://api.polygon.io/v1/last/stocks/${stockCode}?apikey=free`);
                        const polygonData = await polygonResponse.json();
                        
                        if (polygonData.last && polygonData.last.trade && polygonData.last.trade.p) {
                            price = polygonData.last.trade.p;
                            apiSource = 'Polygon.io';
                        }
                    } catch (polygonError) {
                        console.log('Polygon.io APIË∞ÉÁî®Â§±Ë¥•:', polygonError);
                    }
                }
                
                // 6. Â∞ùËØï‰ΩøÁî®‰ª£ÁêÜAPIËÆøÈóÆYahoo Finance
                if (!price) {
                    try {
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${stockCode}`)}`);
                        const proxyData = await proxyResponse.json();
                        const yahooData = JSON.parse(proxyData.contents);
                        
                        if (yahooData.chart && yahooData.chart.result && yahooData.chart.result[0]) {
                            const quote = yahooData.chart.result[0].meta;
                            price = quote.regularMarketPrice;
                            apiSource = 'Yahoo Finance (‰ª£ÁêÜ)';
                        }
                    } catch (proxyError) {
                        console.log('‰ª£ÁêÜAPIË∞ÉÁî®Â§±Ë¥•:', proxyError);
                    }
                }
                
                // 7. Â∞ùËØï‰ΩøÁî®‰ª£ÁêÜAPIËÆøÈóÆÊñ∞Êµ™Ë¥¢ÁªèÁæéËÇ°
                if (!price) {
                    try {
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`http://hq.sinajs.cn/list=gb_${stockCode.toLowerCase()}`)}`);
                        const proxyData = await proxyResponse.json();
                        const sinaData = proxyData.contents;
                        
                        if (sinaData && sinaData.includes(',')) {
                            const parts = sinaData.split(',');
                            if (parts.length > 1 && parts[1]) {
                                price = parseFloat(parts[1]);
                                apiSource = 'Êñ∞Êµ™Ë¥¢ÁªèÁæéËÇ° (‰ª£ÁêÜ)';
                            }
                        }
                    } catch (sinaError) {
                        console.log('Êñ∞Êµ™Ë¥¢ÁªèÁæéËÇ°APIË∞ÉÁî®Â§±Ë¥•:', sinaError);
                    }
                }
                
                // 8. Â∞ùËØï‰ΩøÁî®‰ª£ÁêÜAPIËÆøÈóÆËÖæËÆØË¥¢ÁªèÁæéËÇ°
                if (!price) {
                    try {
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`http://qt.gtimg.cn/q=us${stockCode}`)}`);
                        const proxyData = await proxyResponse.json();
                        const tencentData = proxyData.contents;
                        
                        if (tencentData && tencentData.includes('~')) {
                            const parts = tencentData.split('~');
                            if (parts.length > 3 && parts[3]) {
                                price = parseFloat(parts[3]);
                                apiSource = 'ËÖæËÆØË¥¢ÁªèÁæéËÇ° (‰ª£ÁêÜ)';
                            }
                        }
                    } catch (tencentError) {
                        console.log('ËÖæËÆØË¥¢ÁªèÁæéËÇ°APIË∞ÉÁî®Â§±Ë¥•:', tencentError);
                    }
                }
                
                // 9. Â∞ùËØï‰ΩøÁî®CORS‰ª£ÁêÜ
                if (!price) {
                    try {
                        const corsProxyResponse = await fetch(`https://cors-anywhere.herokuapp.com/https://query1.finance.yahoo.com/v8/finance/chart/${stockCode}`);
                        const corsProxyData = await corsProxyResponse.json();
                        
                        if (corsProxyData.chart && corsProxyData.chart.result && corsProxyData.chart.result[0]) {
                            const quote = corsProxyData.chart.result[0].meta;
                            price = quote.regularMarketPrice;
                            apiSource = 'Yahoo Finance (CORS‰ª£ÁêÜ)';
                        }
                    } catch (corsError) {
                        console.log('CORS‰ª£ÁêÜAPIË∞ÉÁî®Â§±Ë¥•:', corsError);
                    }
                }
                
                // 10. Â∞ùËØïIEX Cloud API (ÂÖçË¥π)
                if (!price) {
                    try {
                        const iexResponse = await fetch(`https://cloud.iexapis.com/stable/stock/${stockCode}/quote?token=free`);
                        const iexData = await iexResponse.json();
                        
                        if (iexData.latestPrice && iexData.latestPrice > 0) {
                            price = iexData.latestPrice;
                            apiSource = 'IEX Cloud';
                        }
                    } catch (iexError) {
                        console.log('IEX Cloud APIË∞ÉÁî®Â§±Ë¥•:', iexError);
                    }
                }
                
                if (price && price > 0) {
                    input.value = price.toFixed(2);
                    showSuccessMessage(`‚úÖ ${stockCode} ËÇ°‰ª∑Â∑≤Êõ¥Êñ∞: $${price.toFixed(2)} (Êù•Ê∫ê: ${apiSource})`);
                    // Âª∂ËøüËÆ°ÁÆóÔºåÁ°Æ‰øùÊï∞ÊçÆÂ∑≤Â°´ÂÖÖ
                    setTimeout(() => {
                        autoCalculate();
                    }, 100);
                } else {
                    throw new Error('ÊâÄÊúâAPIÈÉΩÊó†Ê≥ïËé∑ÂèñËÇ°‰ª∑Êï∞ÊçÆ');
                }
                
            } catch (error) {
                console.error('Ëé∑ÂèñÁæéËÇ°‰ª∑Ê†ºÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊâÄÊúâAPIÈÉΩÂ§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                const mockPrice = Math.random() * 50 + 10; // Ê®°Êãü‰ª∑Ê†º 10-60 USD
                input.value = mockPrice.toFixed(2);
                showSuccessMessage(`‚ö†Ô∏è ${stockCode} ‰ΩøÁî®Ê®°Êãü‰ª∑Ê†º: $${mockPrice.toFixed(2)} (ÊâÄÊúâAPIË∞ÉÁî®Â§±Ë¥•)`);
                setTimeout(() => {
                    autoCalculate();
                }, 100);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }
        
        async function fetchHKStockPrice() {
            const btn = document.getElementById('fetchHkPriceBtn');
            const input = document.getElementById('hkPrice');
            const stockCode = document.getElementById('hkStockCode').value.trim();
            const originalText = btn.textContent;
            
            if (!stockCode) {
                showError('ËØ∑ËæìÂÖ•Ê∏ØËÇ°‰ª£Á†Å');
                return;
            }
            
            btn.textContent = '‚è≥ Ëé∑Âèñ‰∏≠...';
            btn.disabled = true;
            btn.classList.add('loading');
            
            try {
                // Â∞ùËØïÂ§ö‰∏™APIÊ∫ê
                let price = null;
                let apiSource = '';
                
                // 1. Â∞ùËØïYahoo Finance API (Ê∏ØËÇ°ÈúÄË¶ÅÊ∑ªÂä†.HKÂêéÁºÄ)
                try {
                    const yahooCode = stockCode + '.HK';
                    const yahooResponse = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`);
                    const yahooData = await yahooResponse.json();
                    
                    if (yahooData.chart && yahooData.chart.result && yahooData.chart.result[0]) {
                        const quote = yahooData.chart.result[0].meta;
                        price = quote.regularMarketPrice;
                        apiSource = 'Yahoo Finance';
                    }
                } catch (yahooError) {
                    console.log('Yahoo Finance APIË∞ÉÁî®Â§±Ë¥•:', yahooError);
                }
                
                // 2. Â∞ùËØï‰ΩøÁî®‰ª£ÁêÜAPIËÆøÈóÆÊñ∞Êµ™Ë¥¢Áªè
                if (!price) {
                    try {
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`http://hq.sinajs.cn/list=hk${stockCode}`)}`);
                        const proxyData = await proxyResponse.json();
                        const sinaData = proxyData.contents;
                        
                        if (sinaData && sinaData.includes(',')) {
                            const parts = sinaData.split(',');
                            if (parts.length > 3 && parts[3]) {
                                price = parseFloat(parts[3]);
                                apiSource = 'Êñ∞Êµ™Ë¥¢Áªè (‰ª£ÁêÜ)';
                            }
                        }
                    } catch (sinaError) {
                        console.log('Êñ∞Êµ™Ë¥¢ÁªèAPIË∞ÉÁî®Â§±Ë¥•:', sinaError);
                    }
                }
                
                // 3. Â∞ùËØï‰ΩøÁî®‰ª£ÁêÜAPIËÆøÈóÆËÖæËÆØË¥¢Áªè
                if (!price) {
                    try {
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`http://qt.gtimg.cn/q=hk${stockCode}`)}`);
                        const proxyData = await proxyResponse.json();
                        const tencentData = proxyData.contents;
                        
                        if (tencentData && tencentData.includes('~')) {
                            const parts = tencentData.split('~');
                            if (parts.length > 3 && parts[3]) {
                                price = parseFloat(parts[3]);
                                apiSource = 'ËÖæËÆØË¥¢Áªè (‰ª£ÁêÜ)';
                            }
                        }
                    } catch (tencentError) {
                        console.log('ËÖæËÆØË¥¢ÁªèAPIË∞ÉÁî®Â§±Ë¥•:', tencentError);
                    }
                }
                
                // 4. Â∞ùËØï‰ΩøÁî®‰ª£ÁêÜAPIËÆøÈóÆYahoo Finance
                if (!price) {
                    try {
                        const yahooCode = stockCode + '.HK';
                        const proxyResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`)}`);
                        const proxyData = await proxyResponse.json();
                        const yahooData = JSON.parse(proxyData.contents);
                        
                        if (yahooData.chart && yahooData.chart.result && yahooData.chart.result[0]) {
                            const quote = yahooData.chart.result[0].meta;
                            price = quote.regularMarketPrice;
                            apiSource = 'Yahoo Finance (‰ª£ÁêÜ)';
                        }
                    } catch (proxyError) {
                        console.log('‰ª£ÁêÜAPIË∞ÉÁî®Â§±Ë¥•:', proxyError);
                    }
                }
                
                // 5. Â∞ùËØïFinnhub API (ÂÖçË¥π) - Ê∏ØËÇ°
                if (!price) {
                    try {
                        const yahooCode = stockCode + '.HK';
                        const finnhubResponse = await fetch(`https://finnhub.io/api/v1/quote?symbol=${yahooCode}&token=free`);
                        const finnhubData = await finnhubResponse.json();
                        
                        if (finnhubData.c && finnhubData.c > 0) {
                            price = finnhubData.c;
                            apiSource = 'Finnhub';
                        }
                    } catch (finnhubError) {
                        console.log('Finnhub APIË∞ÉÁî®Â§±Ë¥•:', finnhubError);
                    }
                }
                
                // 6. Â∞ùËØïAlpha Vantage API (Â¶ÇÊûúÊúâAPI Key)
                if (!price) {
                    try {
                        const alphaVantageKey = 'demo'; // ÂÖçË¥πÁâàÊúâÈôêÂà∂
                        const alphaResponse = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${stockCode}.HK&apikey=${alphaVantageKey}`);
                        const alphaData = await alphaResponse.json();
                        
                        if (alphaData['Global Quote'] && alphaData['Global Quote']['05. price']) {
                            price = parseFloat(alphaData['Global Quote']['05. price']);
                            apiSource = 'Alpha Vantage';
                        }
                    } catch (alphaError) {
                        console.log('Alpha Vantage APIË∞ÉÁî®Â§±Ë¥•:', alphaError);
                    }
                }
                
                // 7. Â∞ùËØïIEX Cloud API (ÂÖçË¥π) - Ê∏ØËÇ°
                if (!price) {
                    try {
                        const iexResponse = await fetch(`https://cloud.iexapis.com/stable/stock/${stockCode}.HK/quote?token=free`);
                        const iexData = await iexResponse.json();
                        
                        if (iexData.latestPrice && iexData.latestPrice > 0) {
                            price = iexData.latestPrice;
                            apiSource = 'IEX Cloud';
                        }
                    } catch (iexError) {
                        console.log('IEX Cloud APIË∞ÉÁî®Â§±Ë¥•:', iexError);
                    }
                }
                
                // 8. Â∞ùËØï‰ΩøÁî®Âè¶‰∏Ä‰∏™‰ª£ÁêÜÊúçÂä°
                if (!price) {
                    try {
                        const yahooCode = stockCode + '.HK';
                        const corsProxyResponse = await fetch(`https://cors-anywhere.herokuapp.com/https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`);
                        const corsProxyData = await corsProxyResponse.json();
                        
                        if (corsProxyData.chart && corsProxyData.chart.result && corsProxyData.chart.result[0]) {
                            const quote = corsProxyData.chart.result[0].meta;
                            price = quote.regularMarketPrice;
                            apiSource = 'Yahoo Finance (CORS‰ª£ÁêÜ)';
                        }
                    } catch (corsError) {
                        console.log('CORS‰ª£ÁêÜAPIË∞ÉÁî®Â§±Ë¥•:', corsError);
                    }
                }
                
                if (price && price > 0) {
                    input.value = price.toFixed(2);
                    showSuccessMessage(`‚úÖ ${stockCode} ËÇ°‰ª∑Â∑≤Êõ¥Êñ∞: HK$${price.toFixed(2)} (Êù•Ê∫ê: ${apiSource})`);
                    // Âª∂ËøüËÆ°ÁÆóÔºåÁ°Æ‰øùÊï∞ÊçÆÂ∑≤Â°´ÂÖÖ
                    setTimeout(() => {
                        autoCalculate();
                    }, 100);
                } else {
                    throw new Error('ÊâÄÊúâAPIÈÉΩÊó†Ê≥ïËé∑ÂèñËÇ°‰ª∑Êï∞ÊçÆ');
                }
                
            } catch (error) {
                console.error('Ëé∑ÂèñÊ∏ØËÇ°‰ª∑Ê†ºÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊâÄÊúâAPIÈÉΩÂ§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                const mockPrice = Math.random() * 20 + 5; // Ê®°Êãü‰ª∑Ê†º 5-25 HKD
                input.value = mockPrice.toFixed(2);
                showSuccessMessage(`‚ö†Ô∏è ${stockCode} ‰ΩøÁî®Ê®°Êãü‰ª∑Ê†º: HK$${mockPrice.toFixed(2)} (ÊâÄÊúâAPIË∞ÉÁî®Â§±Ë¥•)`);
                setTimeout(() => {
                    autoCalculate();
                }, 100);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }
        
        async function fetchAllStockData() {
            const allBtn = document.querySelector('button[onclick="fetchAllStockData()"]');
            const originalText = allBtn ? allBtn.textContent : '';
            
            if (allBtn) {
                allBtn.textContent = '‚è≥ Ëé∑ÂèñÊâÄÊúâÊï∞ÊçÆ‰∏≠...';
                allBtn.disabled = true;
                allBtn.classList.add('loading');
            }
            
            try {
                // ÂêåÊó∂Ëé∑ÂèñËÇ°‰ª∑ÂíåÊ±áÁéá
                await Promise.all([
                    fetchUSStockPrice(),
                    fetchHKStockPrice(),
                    fetchAllExchangeRates()
                ]);
                
                // Ëé∑ÂèñÂÆåÊï∞ÊçÆÂêéËá™Âä®ËÆ°ÁÆó
                setTimeout(() => {
                    calculateValue();
                }, 500); // Âª∂Ëøü500msÁ°Æ‰øùÊï∞ÊçÆÂ∑≤Â°´ÂÖÖ
                
                showSuccessMessage('‚úÖ ÊâÄÊúâËÇ°‰ª∑ÂíåÊ±áÁéáÊï∞ÊçÆÂ∑≤Êõ¥Êñ∞ÂÆåÊàêÔºåÂπ∂Ëá™Âä®ËÆ°ÁÆó‰ª∑ÂÄºÔºÅ');
            } catch (error) {
                console.error('Ëé∑ÂèñÊâÄÊúâÊï∞ÊçÆÂ§±Ë¥•:', error);
                showError('Ëé∑ÂèñÊï∞ÊçÆÊó∂Âá∫Áé∞ÈîôËØØÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
            } finally {
                if (allBtn) {
                    allBtn.textContent = originalText;
                    allBtn.disabled = false;
                    allBtn.classList.remove('loading');
                }
            }
        }
        
        // Ê±áÁéáËé∑ÂèñÂäüËÉΩ
        async function fetchUSDExchangeRate() {
            const btn = document.getElementById('fetchUsdBtn');
            const input = document.getElementById('usdToCny');
            const originalText = btn.textContent;
            
            btn.textContent = '‚è≥ Ëé∑Âèñ‰∏≠...';
            btn.disabled = true;
            btn.classList.add('loading');
            
            try {
                // ‰ΩøÁî®ÂÖçË¥πÁöÑÊ±áÁéáAPI
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                
                if (data.rates && data.rates.CNY) {
                    const rate = data.rates.CNY;
                    input.value = rate.toFixed(4);
                    
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    showSuccessMessage('‚úÖ USD/CNY Ê±áÁéáÂ∑≤Êõ¥Êñ∞: ' + rate.toFixed(4) + 'ÔºåÂπ∂Ëá™Âä®ËÆ°ÁÆó‰ª∑ÂÄºÔºÅ');
                    
                    // Ëá™Âä®ËÆ°ÁÆó
                    setTimeout(() => {
                        autoCalculate();
                    }, 100);
                } else {
                    throw new Error('Êó†Ê≥ïËé∑ÂèñUSDÊ±áÁéáÊï∞ÊçÆ');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñUSDÊ±áÁéáÂ§±Ë¥•:', error);
                showError('Ëé∑ÂèñÁæéÂÖÉÊ±áÁéáÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®ËæìÂÖ•Ê±áÁéá');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }
        
        async function fetchHKDExchangeRate() {
            const btn = document.getElementById('fetchHkdBtn');
            const input = document.getElementById('hkdToCny');
            const originalText = btn.textContent;
            
            btn.textContent = '‚è≥ Ëé∑Âèñ‰∏≠...';
            btn.disabled = true;
            btn.classList.add('loading');
            
            try {
                // ‰ΩøÁî®ÂÖçË¥πÁöÑÊ±áÁéáAPI
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/HKD');
                const data = await response.json();
                
                if (data.rates && data.rates.CNY) {
                    const rate = data.rates.CNY;
                    input.value = rate.toFixed(4);
                    
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    showSuccessMessage('‚úÖ HKD/CNY Ê±áÁéáÂ∑≤Êõ¥Êñ∞: ' + rate.toFixed(4) + 'ÔºåÂπ∂Ëá™Âä®ËÆ°ÁÆó‰ª∑ÂÄºÔºÅ');
                    
                    // Ëá™Âä®ËÆ°ÁÆó
                    setTimeout(() => {
                        autoCalculate();
                    }, 100);
                } else {
                    throw new Error('Êó†Ê≥ïËé∑ÂèñHKDÊ±áÁéáÊï∞ÊçÆ');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñHKDÊ±áÁéáÂ§±Ë¥•:', error);
                showError('Ëé∑ÂèñÊ∏ØÂÖÉÊ±áÁéáÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®ËæìÂÖ•Ê±áÁéá');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }
        
        async function fetchAllExchangeRates() {
            const allBtn = document.querySelector('button[onclick="fetchAllExchangeRates()"]');
            const originalText = allBtn.textContent;
            
            allBtn.textContent = '‚è≥ Ëé∑ÂèñÊâÄÊúâÊ±áÁéá‰∏≠...';
            allBtn.disabled = true;
            allBtn.classList.add('loading');
            
            try {
                // ÂêåÊó∂Ëé∑ÂèñUSDÂíåHKDÊ±áÁéá
                const [usdResponse, hkdResponse] = await Promise.all([
                    fetch('https://api.exchangerate-api.com/v4/latest/USD'),
                    fetch('https://api.exchangerate-api.com/v4/latest/HKD')
                ]);
                
                const usdData = await usdResponse.json();
                const hkdData = await hkdResponse.json();
                
                if (usdData.rates && usdData.rates.CNY && hkdData.rates && hkdData.rates.CNY) {
                    const usdRate = usdData.rates.CNY;
                    const hkdRate = hkdData.rates.CNY;
                    
                    document.getElementById('usdToCny').value = usdRate.toFixed(4);
                    document.getElementById('hkdToCny').value = hkdRate.toFixed(4);
                    
                    // ÈöêËóèËá™Âä®Âä†ËΩΩÊèêÁ§∫
                    hideAutoLoadingMessage();
                    
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    showSuccessMessage(`‚úÖ ÊâÄÊúâÊ±áÁéáÂ∑≤Êõ¥Êñ∞ÔºåÂπ∂Ëá™Âä®ËÆ°ÁÆó‰ª∑ÂÄºÔºÅ<br>
                        USD/CNY: ${usdRate.toFixed(4)}<br>
                        HKD/CNY: ${hkdRate.toFixed(4)}`);
                    
                    // Ëá™Âä®ËÆ°ÁÆó
                    setTimeout(() => {
                        autoCalculate();
                    }, 100);
                } else {
                    throw new Error('Êó†Ê≥ïËé∑ÂèñÊ±áÁéáÊï∞ÊçÆ');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÊ±áÁéáÂ§±Ë¥•:', error);
                hideAutoLoadingMessage();
                showError('Ëé∑ÂèñÊ±áÁéáÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÊâãÂä®ËæìÂÖ•Ê±áÁéá');
            } finally {
                allBtn.textContent = originalText;
                allBtn.disabled = false;
                allBtn.classList.remove('loading');
            }
        }
        
        function showSuccessMessage(message) {
            // ÁßªÈô§‰πãÂâçÁöÑÊàêÂäüÊ∂àÊÅØ
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = message;
            
            // ÊèíÂÖ•Âà∞Ë°®ÂçïÂÆπÂô®‰∏≠
            const formContainer = document.querySelector('.form-container');
            const calculateBtn = document.querySelector('.calculate-btn');
            formContainer.insertBefore(successDiv, calculateBtn);
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
        }
        
        // localStorage ÂäüËÉΩ
        function saveToLocalStorage() {
            const data = {
                shares: document.getElementById('shares').value,
                strikePrice: document.getElementById('strikePrice').value,
                usStockCode: document.getElementById('usStockCode').value,
                usPrice: document.getElementById('usPrice').value,
                usdToCny: document.getElementById('usdToCny').value,
                hkStockCode: document.getElementById('hkStockCode').value,
                hkPrice: document.getElementById('hkPrice').value,
                hkdToCny: document.getElementById('hkdToCny').value
            };
            localStorage.setItem('stockCalculatorData', JSON.stringify(data));
        }
        
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('stockCalculatorData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.shares) document.getElementById('shares').value = data.shares;
                    if (data.strikePrice) document.getElementById('strikePrice').value = data.strikePrice;
                    if (data.usStockCode) document.getElementById('usStockCode').value = data.usStockCode;
                    if (data.usPrice) document.getElementById('usPrice').value = data.usPrice;
                    if (data.usdToCny) document.getElementById('usdToCny').value = data.usdToCny;
                    if (data.hkStockCode) document.getElementById('hkStockCode').value = data.hkStockCode;
                    if (data.hkPrice) document.getElementById('hkPrice').value = data.hkPrice;
                    if (data.hkdToCny) document.getElementById('hkdToCny').value = data.hkdToCny;
                } catch (e) {
                    console.log('Âä†ËΩΩÊú¨Âú∞Êï∞ÊçÆÂ§±Ë¥•:', e);
                }
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('stockCalculatorData');
            // Ê∏ÖÁ©∫ÊâÄÊúâËæìÂÖ•Ê°Ü
            document.getElementById('shares').value = '';
            document.getElementById('strikePrice').value = '';
            document.getElementById('usStockCode').value = '';
            document.getElementById('usPrice').value = '';
            document.getElementById('usdToCny').value = '';
            document.getElementById('hkStockCode').value = '';
            document.getElementById('hkPrice').value = '';
            document.getElementById('hkdToCny').value = '';
            showSuccessMessage('‚úÖ Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÔºåÂπ∂Ëá™Âä®ËÆ°ÁÆó‰ª∑ÂÄºÔºÅ');
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÈöêËóèÁªìÊûúÂå∫ÂüüÂπ∂Ëá™Âä®Ëé∑ÂèñÊ±áÁéá
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('results').style.display = 'none';
            
            // Âä†ËΩΩÊú¨Âú∞‰øùÂ≠òÁöÑÊï∞ÊçÆ
            loadFromLocalStorage();
            
            // ÊòæÁ§∫Ëá™Âä®Âä†ËΩΩÊèêÁ§∫
            showAutoLoadingMessage();
            
            // È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®Ëé∑ÂèñÊâÄÊúâÊï∞ÊçÆÔºàËÇ°‰ª∑ÂíåÊ±áÁéáÔºâÂπ∂ËÆ°ÁÆó
            setTimeout(() => {
                fetchAllStockData();
            }, 500); // Âª∂Ëøü500msÁ°Æ‰øùÈ°µÈù¢ÂÆåÂÖ®Âä†ËΩΩ
        });
        
        function showAutoLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'auto-loading';
            loadingDiv.innerHTML = 'üîÑ Ê≠£Âú®Ëá™Âä®Ëé∑ÂèñÊúÄÊñ∞ËÇ°‰ª∑ÂíåÊ±áÁéáÊï∞ÊçÆÔºåÂπ∂Ëá™Âä®ËÆ°ÁÆó‰ª∑ÂÄº...';
            loadingDiv.id = 'auto-loading-message';
            
            // ÊèíÂÖ•Âà∞‰ΩøÁî®ËØ¥Êòé‰πãÂêé
            const infoTip = document.querySelector('.info-tip');
            infoTip.parentNode.insertBefore(loadingDiv, infoTip.nextSibling);
        }
        
        function hideAutoLoadingMessage() {
            const loadingDiv = document.getElementById('auto-loading-message');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
    </script>
</body>
</html>
